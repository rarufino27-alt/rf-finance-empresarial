<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vendas | RF Finance Empresarial</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="../manifest.json">

<link rel="stylesheet" href="../theme/variables.css">
<link rel="stylesheet" href="../theme/global.css">
</head>
<body>

<!-- MENU -->
<div id="menu"></div>

<main class="container">
  <h1>Registrar Venda</h1>
  <p>O sistema registra a venda com custo, imposto e lucro reais.</p>

  <label>Produto</label>
  <select id="produto"></select>

  <label>Margem de Lucro (%)</label>
  <input id="margem" type="number" placeholder="Ex: 30">

  <label>Quantidade</label>
  <input id="quantidade" type="number" value="1" min="1">

  <button onclick="registrarVenda()">Registrar Venda</button>

  <div id="preview" style="display:none; margin-top:20px;">
    <h2>Resumo da Venda</h2>
    <p>Preço unitário: R$ <strong id="precoUnit"></strong></p>
    <p>Imposto unitário: R$ <strong id="impostoUnit"></strong></p>
    <p>Lucro unitário: R$ <strong id="lucroUnit"></strong></p>
  </div>
</main>

<!-- CORE SCRIPTS -->
<script src="../core/datamanager.js"></script>
<script src="../core/custos.engine.js"></script>
<script src="../core/impostos.engine.js"></script>
<script src="../core/precificacao.engine.js"></script>

<!-- MENU LOAD -->
<script>
fetch("menu.html")
  .then(r => r.text())
  .then(html => document.getElementById("menu").innerHTML = html);
</script>

<!-- VENDAS LOGIC -->
<script>
function carregarProdutos() {
  const select = document.getElementById("produto");
  select.innerHTML = "";

  const produtos = DataManager.get("produtos") || [];

  produtos.forEach((p, i) => {
    const op = document.createElement("option");
    op.value = i;
    op.textContent = p.nome;
    select.appendChild(op);
  });
}

function registrarVenda() {
  const margemEl = document.getElementById("margem");
  const qtdEl = document.getElementById("quantidade");

  if (!margemEl.value || !qtdEl.value || Number(qtdEl.value) <= 0) {
    alert("Informe uma margem válida e quantidade maior que zero");
    return;
  }

  const prod = DataManager.get("produtos")[produto.value];
  if (!prod) {
    alert("Selecione um produto");
    return;
  }

  const margemLucro = Number(margemEl.value);
  const qtd = Number(qtdEl.value);

  const r = PrecificacaoEngine.calcular(prod, margemLucro);

  DataManager.push("vendas", {
    produto: prod.nome,
    quantidade: qtd,
    precoVenda: r.precoIdeal * qtd,
    custoProduto: r.custo * qtd,
    imposto: r.impostoValor * qtd,
    lucro: r.lucroUnitario * qtd,
    data: new Date().toISOString()
  });

  document.getElementById("precoUnit").innerText = r.precoIdeal.toFixed(2);
  document.getElementById("impostoUnit").innerText = r.impostoValor.toFixed(2);
  document.getElementById("lucroUnit").innerText = r.lucroUnitario.toFixed(2);
  document.getElementById("preview").style.display = "block";

  alert("Venda registrada com sucesso");
}

carregarProdutos();
</script>

<!-- SERVICE WORKER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("../service-worker.js");
}
</script>

</body>
</html>